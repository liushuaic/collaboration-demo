(function($) {
	window.jUploader = $.jUploader = function(options) {
		options = $.extend({}, $.jUploader.defaults, options);
		options.id = $.jUploader.createId();
		options.uploading = false;
		var initButton = function() {
			options.button = (typeof options.button == "string") ? $("#" + options.button) : $(options.button);
			options.button.css({
				cursor: "pointer",
				position: "relative",
				overflow: "hidden",
				direction: "ltr"
			}).addClass("jUploader-button").bind("mouseover", function() {
				$(this).addClass("jUploader-button-hover")
			}).bind("mouseout", function() {
				$(this).removeClass("jUploader-button-hover")
			}).children("span").text(options.messages.upload);
			if(options.cancelable) {
				options.button.bind("click", cancel)
			}
			options.button.append(createInput());
			return options.button
		};
		var createIframe = function() {
			var id = "jUploaderIframe" + options.id;
			var iframe = $('<iframe id="' + id + '" name="' + id + '" src="javascript:false;" style="display:none"></iframe>').bind("load", complete);
			return iframe
		};
		var createForm = function() {
			var id = "jUploaderForm" + options.id;
			var form = $('<form id="' + id + '" name="' + id + '" action="' + options.action + '" target="jUploaderIframe' + options.id + '" method="post" enctype="multipart/form-data" style="display:none"></form>');
			return form
		};
		var createInput = function() {
			var input = $('<input type="file" onchange="this.blur();" />');
			//input.attr("id", "jUploader-file" + options.id).attr("name", "jUploaderFile").css({
			input.attr("id", "jUploader-file" + options.id).attr("name", "multipartFile").css({
				position: "absolute",
				right: 0,
				top: 0,
				margin: 0,
				opacity: 0,
				padding: 0,
				fontFamily: "Arial",
				fontSize: "118px",
				verticalAlign: "baseline",
				cursor: "pointer"
			}).bind("change", function() {
				options.fileName = getFileName(this);
				if(validateFile(this)) {
					//添加图片限制大小
					if(checkfile(5)) {
						//console.log(55555555555555555555555)
						upload();
						var sessionKey = sessionStorage.getItem('contact');
						if(sessionKey == "myContact") {
							$(".js_img_msg").addClass("gray");
							$(".js_img_msg").removeClass("Validform_right").removeClass("Validform_wrong");
			                $(".js_img_msg").html("支持JPG、JPEG、PNG，大小不超过5M");
						} 
					} else {
						var sessionKey = sessionStorage.getItem('contact');
						if(sessionKey == "myContact") {
							$(".js_img_msg").removeClass("gray");
							$(".js_img_msg").removeClass("Validform_right").addClass("Validform_wrong");
			                $(".js_img_msg").html("<i class='iconfont icon-information-solid'></i>图片大小不可超过5M");
						} else {
//							console.log(666666666666666666666666)
							globalShade2('图片大小不可超过' + options.fillsize + 'M', 2, '2000');
						}

					}
				}
				//console.log(this.files[0]);
				//if(window.ActiveXObject) {
				//    console.log(1111)
				//    var myFSO = new ActiveXObject("Scripting.FileSystemObject");
				//    var filepath = document.upload.file.value;
				//    var thefile = myFSO.getFile(filepath);
				//    var size = thefile.size;
				//    alert(size + " bytes");
				//}
				//
				//
				//
				//console.log(this,111111,this.files)
				//var fileSize = this.files[0].size;
				//if(fileSize<(options.fillsize*1048576)){
				//    if (validateFile(this)) {
				//        upload()
				//    }
				//}else{
				//    //这里使用了自定义的弹窗
				//    globalShade2('图片大小不可超过'+options.fillsize+'m',2,'2000');
				//
				//}
			});
			if(window.attachEvent) {
				input.attr("tabIndex", "-1")
			}
			return input
		};

		//function getSize()
		//{
		//    var myFSO = new ActiveXObject("Scripting.FileSystemObject");
		//    var filepath = document.upload.file.value;
		//    var thefile = myFSO.getFile(filepath);
		//    var size = thefile.size;
		//    alert(size + " bytes");
		//}

		var validateFile = function(file) {
			var name = getFileName(file);
			if(!isAllowedExtension(name)) {
				//showMessage("invalidExtension", name);
				var sessionKey = sessionStorage.getItem('contact');
				if(sessionKey == "myContact") {
					$(".js_img_msg").removeClass("gray");
					$(".js_img_msg").removeClass("Validform_right").addClass("Validform_wrong");
					$(".js_img_msg").html("<i class='iconfont icon-information-solid'></i>只能上传JPG、JPEG、PNG格式图片");
				} else {
					globalShade2('只能上传JPG、JPEG、PNG格式图片', 2, 2000);
				}

				setInput();
				return false
			} else {
				if(name == "") {
					showMessage("emptyFile", name);
					return false
				}

			}
			return true
		};
		var getFileName = function(file) {
			return file.value.replace(/.*(\/|\\)/, "")
		};
		var formatFileName = function(name) {
			if(name.length > 33) {
				name = name.slice(0, 19) + "..." + name.slice(-13)
			}
			return name
		};
		var isAllowedExtension = function(fileName) {
			var ext = (-1 !== fileName.indexOf(".")) ? fileName.replace(/.*[.]/, "").toLowerCase() : "";
			if(!options.allowedExtensions.length) {
				return true
			}
			for(var i = 0; i < options.allowedExtensions.length; i++) {
				if(options.allowedExtensions[i].toLowerCase() == ext) {
					return true
				}
			}
			return false
		};
		var showMessage = function(type, fileName) {
			var message = options.messages[type].replace("{file}", formatFileName(fileName)).replace("{extensions}", options.allowedExtensions.join(", "));
			options.showMessage(message)
		};
		var log = function(message) {
			if(options.debug && window.console) {
//				console.log("[jUploader] " + message)
			}
		};
		var upload = function() {
			options.uploading = true;
			// console.log('dadadad');
			options.onUpload(options.fileName);
			$(document.body).append(createIframe()).append(createForm());
			$("#jUploader-file" + options.id).attr("id", "jUploader-file-uploading" + options.id).appendTo("#jUploaderForm" + options.id);
			options.button.append(createInput().hide());
			if(options.cancelable) {
				options.button.children("span").text(options.messages.cancel)
			}
			$("#jUploaderForm" + options.id).get(0).submit()
		};

		//解决重复选择错误文件不报错的BUG
		var setInput = function() {
			options.uploading = true;
			$(document.body).append(createIframe()).append(createForm());
			$("#jUploader-file" + options.id).attr("id", "jUploader-file-uploading" + options.id).appendTo("#jUploaderForm" + options.id);
			options.button.append(createInput().hide());
			$("#jUploader-file1").show();
			if(options.cancelable) {
				options.button.children("span").text(options.messages.cancel)
			}
		}

		var cancel = function() {
			//alert(1);
			if(options.uploading) {
				options.uploading = false;
				options.onCancel(options.fileName);
				options.button.children("span").text(options.messages.upload);
				$("#jUploaderForm" + options.id).remove();
				$("#jUploaderIframe" + options.id).attr("src", "javascript:false;").remove();
				$("#jUploader-file" + options.id).show()
			}
		};
		var complete = function() {
			var iframe = $("#jUploaderIframe" + options.id).get(0);
			if(!iframe.parentNode) {
				return
			}
			// 解决ie8下上传大于5M图片时报错
           /* try{
                iframe.contentDocument && iframe.contentWindow.document;
            }catch (e){
                var sessionKey = sessionStorage.getItem('contact');
                if(sessionKey == "myContact") {
                    $(".js_img_msg").addClass("gray");
                    $(".js_img_msg").removeClass("Validform_right").removeClass("Validform_wrong");
                    $(".js_img_msg").html("支持JPG、JPEG、PNG，大小不超过5M");
                }else {
                    globalShade2('图片大小不可超过' + options.fillsize + 'M', 2, '2000');
                }
                return
            }*/
            if((iframe.contentDocument && iframe.contentDocument.body && iframe.contentDocument.body.innerHTML == "false") || (iframe.contentWindow.document && iframe.contentWindow.document.body && iframe.contentWindow.document.body.innerHTML == "false")) {
				return
			}
			var doc = iframe.contentDocument ? iframe.contentDocument : iframe.contentWindow.document;
			var response;
			var innerHtml = doc.body.innerHTML;
			log("innerHTML = " + innerHtml);
			if(innerHtml == "") {
				return
			}
			options.uploading = false;
			$("#jUploader-file" + options.id).show();
			options.button.children("span").text(options.messages.upload);
			try {
				var json = innerHtml.replace(/<pre.*>(.*)<\/pre>/g, "$1");
				var jsonTem = json;
				json = json.substring(json.indexOf("{"), json.indexOf("}") + 1);
				response = eval("(" + json + ")")
			} catch(e) {
				jsonTem = jsonTem.replace(/<PRE>/ig, "").replace(/<\/PRE>/ig, "");
				response = jsonTem
			}
			setTimeout(function() {
				$("#jUploaderForm" + options.id).remove();
				$("#jUploaderIframe" + options.id).remove()
			}, 10);
			options.onComplete(options.fileName, response)
		};
		$(window).bind("beforeunload", function(e) {
			if(!options.uploading) {
				return
			}
			var e = e || window.event;
			e.returnValue = options.messages.onLeave;
			return options.messages.onLeave
		});
		return initButton()
	};
	$.jUploader.version = 1;
	$.jUploader.defaults = {
		button: null,
		fillsize: null,
		action: "http://image.tongshuai.com/tongshuai/images/upload.aspx",
		allowedExtensions: [],
		cancelable: true,
		onUpload: function(fileName) {},
		onComplete: function(fileName, response) {},
		onCancel: function(fileName) {},
		messages: {
			upload: "Upload",
			cancel: "Cancel",
			emptyFile: "{file} is empty, please select files again without it.",
			invalidExtension: "{file} has invalid extension. Only {extensions} are allowed.",
			onLeave: "The files are being uploaded, if you leave now the upload will be cancelled."
		},
		showMessage: function(message) {
			alert(message)
		},
		debug: false
	};
	$.jUploader.setDefaults = function(defaults) {
		$.jUploader.defaults = $.extend({}, $.jUploader.defaults, defaults)
	};
	$.jUploader.createId = (function() {
		var id = 0;
		return function() {
			return ++id
		}
	})()

	function checkfile(num) {
		var result = true;
		var browserCfg = {};
		var ua = window.navigator.userAgent;
		if(ua.indexOf("MSIE") >= 1) {
			browserCfg.ie = true;
		} else if(ua.indexOf("Firefox") >= 1) {
			browserCfg.firefox = true;
		} else if(ua.indexOf("Chrome") >= 1) {
			browserCfg.chrome = true;
		} else {
			browserCfg.safari = true;
		}
		try {
			var obj_file = document.getElementById("jUploader-file1");
			if(obj_file.value == "") {
				// alert("请先选择上传文件");
				result = false;
			}
			var filesize = 0;
			if(browserCfg.firefox || browserCfg.chrome || browserCfg.safari) {
				filesize = obj_file.files[0].size;
			} else if(browserCfg.ie) {
				var obj_img = document.getElementById('jUploader-file1');
				obj_img.dynsrc = obj_file.value;
				filesize = obj_img.fileSize;
				if("" == filesize || null == filesize || typeof(filesize) == 'undefined') {
					filesize = 1;
				}
			} else {
				// alert(tipMsg);
				result = false;
			}
			if(filesize == -1) {
				// alert(tipMsg);
				result = false;
			} else if(filesize >= 1024 * 1000 * num) {
				// alert(errMsg);
				result = false;
			} else {
				// alert("文件大小符合要求");
				result = true;
			}
		} catch(e) {
			alert(e);
			result = false;
		}
		return result;
	}
})(jQuery);